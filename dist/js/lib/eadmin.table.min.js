/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function n(t,a){for(var e=0;e<a.length;e++){var n=a[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,a,e){return a&&n(t.prototype,a),e&&n(t,e),t}}();function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var Table=function(){function e(t,a){if(_classCallCheck(this,e),this.domCache=scope(t),0!=this.domCache.length){this.window=null!=Mount.window?"#"+Mount.window:null,this.dom=null!=this.window?this.window+" "+t:t,this.page=1,this.size=10,this.pageCount=null,this.searchBox=null,this.toolsBox=null,this.pageBox=null,this.table=null,this.shade=null,this.init=!1,this.btns=[],this.checked=0,this.get={},this.width=parseInt(this.domCache.width());this.color=["#0084ff","#FF2A1E","#4dd13a","#8368ee","#1dd0d7","#f67f1b","#ff6384"];this.param=$.extend(!0,{config:{checkbox:!1,fixed:{first:!1,last:!1},button:[],page:{size:10,num:5,page_field:"page",size_field:"size"},data:""},column:[],search:{}},a),_.has(this.param.config.page,"size")&&(this.size=this.param.config.page.size),this.get[this.param.config.page.page_field]=this.page,this.get[this.param.config.page.size_field]=this.size;this.domCache.addClass("table").before('<div class="table-shade">\n\t\t\t\t\t\t<i class="fa fa-spinner fa-pulse mr5"></i>数据加载中，请稍候...\n\t\t\t\t\t</div>'),this.shade=this.domCache.prev(".table-shade"),this.run()}else console.log("没有找到表格容器"+t+"，创建失败")}return _createClass(e,[{key:"run",value:function(){0!=this.param.column.length?""!=this.param.config.data?(this._create(),this._event()):console.log("没有指定数据源地址，无法创建表格"):console.log("至少为表格添加一列才可以创建表格")}},{key:"_create",value:function(){var o=this,e={html:"",search:[]},n={order:function(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",e="";return!0===t&&(e='<span class="order">\n\t\t\t\t\t\t\t\t<i class="fa fa-caret-up asc" data-order="'+a+',asc"></i>\n\t\t\t\t\t\t\t\t<i class="fa fa-caret-down desc" data-order="'+a+',desc"></i>\n\t\t\t\t\t\t\t</span>'),e},head:function(){e.html+="<thead><tr>",e.html+=o._checkbox(),_.each(o.param.column,function(t,a){e.html+="<td>"+t.name+n.order(t.order,t.field)+"</td>",!0===t.search&&e.search.push(a)}),e.html+="</tr></thead>"},search:function(){if(0!=e.search.length){var i='<div class="table-search"><form><div class="block-box">',l=[];_.each(e.search,function(t,a){i+='<div class="col-lg-3 col-md-3"><div class="form-group">';var e=o.param.column[t];if(null==o.param.search[e.field])i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t<span class="prepend">'+e.name+'</span>\n\t\t\t\t\t\t\t\t\t<input name="'+e.field+'" type="text" \n\t\t\t\t\t\t\t\t\t\tplaceholder="请输入'+e.name+'">\n\t\t\t\t\t\t\t\t</div>';else{var n=o.param.search[e.field];switch(n.type){case"select":i+='<select name="'+e.field+'" data-width="100%">\n\t\t\t\t\t\t\t\t\t\t\t<option value="'+module.conf.select_default_val+'">\n\t\t\t\t\t\t\t\t\t\t\t\t请选择'+e.name+"\n\t\t\t\t\t\t\t\t\t\t\t</option>",_.each(n.option,function(t){i+='<option value="'+t.val+'">\n\t\t\t\t\t\t\t\t\t\t\t\t'+t.key+"\n\t\t\t\t\t\t\t\t\t\t\t</option>"}),i+="</select>";break;case"datepicker":i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+e.name+'</span>\n\t\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\t\tid="table-datepicker-'+a+'" \n\t\t\t\t\t\t\t\t\t\t\t\tclass="table-datepicker"\n\t\t\t\t\t\t\t\t\t\t\t\tname="'+e.field+'" \n\t\t\t\t\t\t\t\t\t\t\t\tdata-key="'+a+'"\n\t\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+e.name+'">\n\t\t\t\t\t\t\t\t\t\t</div>',l[a]=n.param;break;case"citypicker":i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+e.name+'</span>\n\t\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\t\tid="table-citypicker-'+a+'" \n\t\t\t\t\t\t\t\t\t\t\t\tclass="table-citypicker"\n\t\t\t\t\t\t\t\t\t\t\t\tname="'+e.field+'" \n\t\t\t\t\t\t\t\t\t\t\t\tdata-key="'+a+'"\n\t\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+e.name+'">\n\t\t\t\t\t\t\t\t\t\t</div>',l[a]=n.param}}i+="</div></div>"}),i+='<div class="col-lg-3 col-md-3">\n\t\t\t\t\t\t\t<button class="search-do highlight mr10">\n\t\t\t\t\t\t\t\t<i class="fa fa-search"></i>\n\t\t\t\t\t\t\t\t搜索\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button class="search-refresh">\n\t\t\t\t\t\t\t\t<i class="fa fa-refresh"></i>\n\t\t\t\t\t\t\t\t重置\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div></form></div>',o.domCache.before(i),o.searchBox=o.domCache.prev(".table-search"),o.searchBox.find(".table-datepicker").each(function(){var t=$(this);Eadmin.datepicker("#"+t.attr("id"),l[t.data("key")])}),o.searchBox.find(".table-citypicker").each(function(){var t=$(this);Eadmin.citypicker("#"+t.attr("id"),l[t.data("key")])})}},tools:function(){0!=o.param.config.button.length&&(e.tools='<div class="table-tools">',_.each(o.param.config.button,function(t,a){e.tools+='<button id="table-btn-'+a+'" ',e.tools+=0==a?'class="highlight">':">",null!=t.icon&&(e.tools+='<i class="fa '+t.icon+'"></i>'),e.tools+=t.name+"</button>"}),e.tools+="</div>",o.domCache.before(e.tools),o.toolsBox=o.domCache.prev(".table-tools"))},page:function(){if(!_.isBoolean(o.param.config.page)){var t='<div class="table-page">\n\t\t\t\t\t\t\t\t<span class="info">\n\t\t\t\t\t\t\t\t\t共<em></em>条，每页\n\t\t\t\t\t\t\t\t\t<select name="pagesize" data-width="60">\n\t\t\t\t\t\t\t\t\t\t<option value="10"'+(10==o.size?" selected":"")+'>10</option>\n\t\t\t\t\t\t\t\t\t\t<option value="30"'+(30==o.size?" selected":"")+'>30</option>\n\t\t\t\t\t\t\t\t\t\t<option value="50"'+(50==o.size?" selected":"")+'>50</option>\n\t\t\t\t\t\t\t\t\t\t<option value="100"'+(100==o.size?" selected":"")+">100</option>\n\t\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t\t条，\n\t\t\t\t\t\t\t\t\t当前 <em>"+o.page+'</em>/<em>-</em> 页\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span class="prev-page"><i class="fa fa-angle-left"></i></span>\n\t\t\t\t\t\t\t\t<span class="next-page"><i class="fa fa-angle-right"></i></span>\n\t\t\t\t\t\t\t\t<span class="jump">\n\t\t\t\t\t\t\t\t\t跳转到第\n\t\t\t\t\t\t\t\t\t<input name="page" type="text" placeholder="页数">\n\t\t\t\t\t\t\t\t\t页\n\t\t\t\t\t\t\t\t\t<button class="highlight small">确定</button>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>';o.domCache.after(t),o.pageBox=o.domCache.next(".table-page")}},fixed:function(){if(e.fixed="",o.param.config.fixed.first){e.fixed+='<div class="fixed-left">\n\t\t\t\t\t\t\t\t\t<table>\n\t\t\t\t\t\t\t\t\t\t<thead><tr>',e.fixed+=o._checkbox(null,!0);var t=_.head(o.param.column);e.fixed+="<td>"+t.name+n.order(t.order,t.field)+"</td>\n\t\t\t\t\t\t\t\t</tr></thead>",e.fixed+="<tbody></tbody>\n\t\t\t\t\t\t\t\t</table></div>"}if(o.param.config.fixed.last){e.fixed+='<div class="fixed-right">\n\t\t\t\t\t\t\t\t\t<table>\n\t\t\t\t\t\t\t\t\t\t<thead><tr>';var a=_.last(o.param.column);e.fixed+="<td>"+a.name+n.order(a.order,a.field)+"</td>\n\t\t\t\t\t\t\t\t</tr></thead>",e.fixed+="<tbody></tbody>\n\t\t\t\t\t\t\t\t</table></div>"}o.domCache.append(e.fixed)},body:function(){n.head(),n.search(),n.tools(),n.page(),e.html+="<tbody></tbody></table></div>",o.domCache.html(e.html),n.fixed(),0==o.param.config.button.length&&o.domCache.find("thead > tr").addClass("head-border-top"),o.table={head:o.domCache.find("thead"),body:o.domCache.find("tbody"),l:o.domCache.find(".fixed-left").find("tbody"),r:o.domCache.find(".fixed-right").find("tbody"),box:o.domCache.find(".table-box")},o.table.t=o.table.box.children("table"),o.table.c=o.table.t.children("tbody")}};this.shade.css("display","flex"),e.html='<div class="table-box" style="width:'+this.width+'px;">\n\t\t\t\t  \t<table>',n.body(),this._loadData()}},{key:"_event",value:function(){var t=["thead .checkall","tbody .checkall","tbody tr",".search-do",".search-refresh",".table-page select",".table-page .num-page:not(.current)",".table-page .prev-page",".table-page .next-page",".table-page button",".table-tools button",".order i:not(.active)",".checkbox-switch"],i=this,a=i.domCache.parent(),e=function(t){Eadmin.message.error({content:t}),i.pageBox.find("input").val("")},l=function(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(null!=t[module.conf.http.code_field]){var e="";if(null!=t[module.conf.http.msg_field]&&(e=t[module.conf.http.msg_field]),t[module.conf.http.code_field]==module.conf.http.code_success){var n={content:e=""==e?"操作执行成功":e};return null!=a&&(n.callback=a),void Eadmin.popup.success(n)}""==e&&(e="操作执行失败"),Eadmin.popup.error({content:e})}else console.log("接口返回结果中没有找到定义的code码字段")};if(i.param.config.checkbox&&a.on("click",t[0],function(){var t={this:$(this)};t.isCheck=t.this.is(":checked")?1:0,i.checked=1==t.isCheck?i.size:0,i.param.config.fixed.first?t.checkbox=i.table.l.find(".checkall"):t.checkbox=i.table.t.find(".checkall"),Form.checkbox(t.checkbox,t.isCheck)}).on("click",t[1],function(){var t={this:$(this)};i.checked+=t.this.is(":checked")?1:-1,t.checkall=i.table.head.find(".checkall"),t.isCheck=i.checked==i.size?1:0,Form.checkbox(t.checkall,t.isCheck)}),i.param.config.fixed.first||i.param.config.fixed.last){var n=0;a.on("mouseenter",t[2],function(){n=$(this).index(),i.table.c.children("tr").eq(n).addClass("tr-hover"),i.table.l.children("tr").eq(n).addClass("tr-hover"),i.table.r.children("tr").eq(n).addClass("tr-hover")}).on("mouseleave",t[2],function(){i.table.c.children("tr").eq(n).removeClass("tr-hover"),i.table.l.children("tr").eq(n).removeClass("tr-hover"),i.table.r.children("tr").eq(n).removeClass("tr-hover")})}null!=i.searchBox&&a.on("click",t[3],function(){i.page=1,i.get[i.param.config.page.page_field]=i.page;var t=i.searchBox.children("form").serialize(),a=_.split(t,"&");return _.each(a,function(t){var a=_.split(t,"=");i.get[a[0]]=a[1]}),i._loadData(!0),!1}).on("click",t[4],function(){return i.searchBox.find("input").val(""),Form.select(i.searchBox),!1}),null!=i.toolsBox&&_.each(i.param.config.button,function(n,t){var a=i.toolsBox.find("button").eq(t);if(null==n.open)a.on("click",function(){if(!0!==n.check_checked||0!=i.checked){var t=function(){var t=[],a={},e=void 0;0<(e=i.param.config.fixed.first?i.table.l.find(".checkall:checked"):i.table.c.find(".checkall:checked")).length&&(e.each(function(){t.push($(this).val())}),t=_.toString(t),a[i.param.config.checkbox]=t),null==n.api?_.isFunction(n.callback)?n.callback(_.isArray(t)?"":t):console.log("按钮操作没有指明具体操作动作，无法执行"):axios.get(n.api,{params:a}).then(function(t){var a=t.data;l(a,function(){!0===n.refresh&&i._loadData()})})};!0!==n.confirm?t():Eadmin.popup.confirm({content:"确认执行此操作吗？",callback:t})}else Eadmin.popup.error({content:"请至少选择一项执行此操作"})});else{a.data("window-url",n.open.url);var e=a.attr("id");Eadmin.window("#"+e,n.open)}}),_.isBoolean(this.param.config.page)||a.on("change",t[5],function(){i.page=1,i.size=parseInt($(this).val()),i.get[i.param.config.page.page_field]=i.page,i.get[i.param.config.page.size_field]=i.size,i._loadData(!0)}).on("click",t[6],function(){$(this);i.page=parseInt($(this).html()),i.get[i.param.config.page.page_field]=i.page,i._loadData(!0)}).on("click",t[7],function(){1!=i.page&&(i.page-=1,i.get[i.param.config.page.page_field]=i.page,i._loadData(!0))}).on("click",t[8],function(){i.page!=i.pageCount&&(i.page+=1,i.get[i.param.config.page.page_field]=i.page,i._loadData(!0))}).on("click",t[9],function(){var t=i.pageBox.find("input").val();""!=t?t<1?e("跳转的页数不能小于1"):t>i.pageCount?e("跳转的页数已经超出了最大页数"):t!=i.page?(i.page=parseInt(t),i.get[i.param.config.page.page_field]=i.page,i._loadData(!0)):e("已经在待跳转的页面了"):e("跳转的页数不能为空")}),a.on("click",t[11],function(){var t={this:$(this)};i.table.head.find(".active").removeClass("active"),t.this.addClass("active"),i.get.order=t.this.data("order"),i._loadData()}).on("click",t[12],function(){var t={this:$(this)};t.label=t.this.prev("label"),t.api=t.label.data("api"),t.field=t.label.data("field"),t.val=1==t.label.children().val()?0:1,t.param={},t.param[t.field]=t.val,axios.get(t.api,{params:t.param}).then(function(t){var a=t.data;l(a)}).catch(function(t){console.log(t)})}).on("click",".column-btn",function(){var e={this:$(this)};if(e.row=e.this.data("row"),e.key=e.this.data("key"),e.btn=i.btns[e.row][e.key],null==e.btn.open){if(null!=e.btn.api){var t=function(){axios.get(e.btn.api).then(function(t){var a=t.data;l(a,function(){!0===e.btn.refresh&&i._loadData()})})};if(!0===e.btn.confirm)return void Eadmin.popup.confirm({content:"确定执行此操作吗？",callback:t});t()}}else Eadmin.window(!1,e.btn.open)})}},{key:"_checkbox",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return!1===this.param.config.checkbox?"":this.param.config.fixed.first&&!a?'<td class="td-checkbox"><div></div></td>':null==t?'<td class="td-checkbox"><div>\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<input type="checkbox" class="checkall">\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div></td>':null==t[this.param.config.checkbox]?(console.log("复选框绑定的字段"+this.param.config.checkbox+"不存在"),""):'<td class="td-checkbox"></div>\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<input type="checkbox" class="checkall" value="'+t[this.param.config.checkbox]+'">\n\t\t\t\t\t</label>\n\t\t\t\t</div></td>'}},{key:"_page",value:function(t){var a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(!_.isBoolean(this.param.config.page))if(_.has(t,"count")){null!=this.window?$(this.window+" .body")[0].scrollTop=0:box[0].scrollTop=0,this.init||this.pageBox.data("size",this.size);var e={count:this.pageBox.find("em:first"),page:this.pageBox.find("em").eq(1),pageCount:this.pageBox.find("em").eq(2)};t.count==parseInt(e.count.html())&&this.size==this.pageBox.data("size")||(t.count<this.size?this.pageCount=1:t.count%this.size==0?this.pageCount=t.count/this.size:this.pageCount=parseInt(t.count/this.size)+1,e.count.html(t.count),e.pageCount.html(this.pageCount),this.size!=this.pageBox.data("size")&&this.pageBox.data("size",this.size)),e.page.html(this.page);var n=10;_.has(this.param.config.page,"num")&&((n=this.param.config.page.num)<3&&(n=3),10<n&&(n=10));var i="",l=this.page,o=n+((l-=_.floor(n/2))<1?(l=1,0):this.page-_.floor(n/2)-1);o>this.pageCount&&(o=this.pageCount),o-l<n-1&&(l-=n-(o-l)-1),l<1&&(l=1);for(var c=l;c<=o;c++)i+='<span class="num-page'+(c==this.page?" current":"")+'" data-page="'+c+'">'+c+"</span>";this.pageBox.find(".num-page").remove(),this.pageBox.find(".prev-page").after(i),this.init&&a&&Eadmin.message.success({content:"当前第 "+this.page+" 页，共 "+this.pageCount+" 页"})}else console.log("数据源中未包含数据总条数count字段，创建分页失败")}},{key:"_loadData",value:function(){var h=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.checked=0,this.btns=[],this.shade.css("display","flex"),axios.get(this.param.config.data,{params:this.get}).then(function(t){var r={data:t.data,html:"",fl:"",fr:""};if(null!=r.data.count||!1===h.param.config.page)if(null!=r.data.list){_.each(r.data.list,function(s,d){r.fl+="<tr>",r.fr+="<tr>",r.html+="<tr>",r.html+=h._checkbox(s),r.fl+=h._checkbox(s,!0),_.each(h.param.column,function(t,a){var l="<td";if(!0===t.tag&&(l+=' data-tag="'+s[t.field]+'"'),l+=">",!0===t.switch){var e="";_.isFunction(t.api)?e=t.api(s):console.log("没有指定保存开关状态的API地址"),l+='<label class="no-padding" data-api="'+e+'" data-field="'+t.field+'">\n\t\t\t\t\t\t\t\t\t<input type="checkbox" data-model="switch"'+(1==s[t.field]?" checked":"")+">\n\t\t\t\t\t\t\t\t</label>"}else if(_.isFunction(t.button)){var n=t.button(s);h.btns.push(n),_.each(n,function(t,a){var e="";null!=t.icon&&(e='<i class="fa '+t.icon+'"></i>');var n="",i="table-column-btn-"+d+"-"+a;null!=t.open&&(n=t.open.url),l+='<button \n\t\t\t\t\t\t\t\t\t\tid="'+i+'" \n\t\t\t\t\t\t\t\t\t\tdata-row="'+d+'" \n\t\t\t\t\t\t\t\t\t\tdata-key="'+a+'" \n\t\t\t\t\t\t\t\t\t\tdata-window-url="'+n+'" \n\t\t\t\t\t\t\t\t\t\tclass="small mr5 column-btn" \n\t\t\t\t\t\t\t\t\t\tstyle="background:'+h.color[a]+';"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t'+e+" "+t.name+"\n\t\t\t\t\t\t\t\t\t</button>"})}else{var i="";if(!0===t.img)i+='<img src="'+s[t.field]+'"',!0===t.head&&(i+=' class="table-img-head"'),i+=">";else if(_.isFunction(t.status)){var o=t.status(s);i+='<span data-status="'+o.code+'">'+o.name+"</span>"}else i+=s[t.field];if(_.isFunction(t.link)){var c=t.link(s);l+='<a href="'+c.href+'"',!0===c.native&&(l+=' data-native="1"'),null!=c.target&&(l+=' target="'+c.target+'"'),l+=">"}l+=i,null!=t.link&&(l+="</a>")}l+="</td>",0==a&&(r.fl+=l),r.html+=l,a+1==h.param.column.length&&(r.fr+=l)}),r.fl+="</tr>",r.html+="</tr>",r.fr+="</tr>"}),h.table.c.html(r.html),Eadmin.form(h.table.c),Status.run(h.table.c),Tag.run(h.table.c),!0===h.param.config.fixed.first&&(h.table.l.html(r.fl),Eadmin.form(h.table.l),Status.run(h.table.l),Tag.run(h.table.l)),!0===h.param.config.fixed.last&&(h.table.r.html(r.fr),Eadmin.form(h.table.r),Status.run(h.table.r),Tag.run(h.table.r)),h._page(r.data,e);var a=h.table.head.find(":checkbox");a.is(":checked")&&Form.checkbox(a,!1),h.shade.hide(),h.init||(h.table.t.width()<=h.width?h.table.t.width(h.width):(h.domCache.children(".table-box").css("padding-bottom","18px"),Eadmin.scroll(h.dom+" .table-box","x")),h.init=!0)}else console.log("数据源中没有包含list字段，创建表格失败");else console.log("返回的数据源中没有 count 字段，无法使用分页，请在配置中设置 page 为 false")}).catch(function(t){console.log(t)})}}]),e}();