/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function n(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Table=function(){function a(t,e){if(_classCallCheck(this,a),this.domCache=$(t),0!=this.domCache.length){this.dom=t,this.page=1,this.size=10,this.pageCount=null,this.searchBox=null,this.toolsBox=null,this.pageBox=null,this.table=null,this.shade=null,this.init=!1,this.checked=0,this.get={},this.width=parseInt(this.domCache.width());this.color=["#0084ff","#FF2A1E","#4dd13a","#8368ee","#1dd0d7","#f67f1b","#ff6384"];this.param=$.extend(!0,{config:{checkbox:!1,fixed:{first:!1,last:!1},button:[],page:{size:10,num:5,page_field:"page",size_field:"size"},data:""},column:[],search:{}},e),_.has(this.param.config.page,"size")&&(this.size=this.param.config.page.size),this.get[this.param.config.page.page_field]=this.page,this.get[this.param.config.page.size_field]=this.size;this.domCache.addClass("table").before('<div class="table-shade">\n\t\t\t\t\t\t<i class="fa fa-spinner fa-pulse mr5"></i>数据加载中，请稍候...\n\t\t\t\t\t</div>'),this.shade=this.domCache.prev(".table-shade"),this.run()}else console.log("没有找到表格容器"+t+"，创建失败")}return _createClass(a,[{key:"run",value:function(){0!=this.param.column.length?""!=this.param.config.data?(this._create(),this._event()):console.log("没有指定数据源地址，无法创建表格"):console.log("至少为表格添加一列才可以创建表格")}},{key:"_create",value:function(){var l=this,a={html:"",search:[]},n={order:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",a="";return!0===t&&(a='<span class="order">\n\t\t\t\t\t\t\t\t<i class="fa fa-caret-up asc" data-order="'+e+',asc"></i>\n\t\t\t\t\t\t\t\t<i class="fa fa-caret-down desc" data-order="'+e+',desc"></i>\n\t\t\t\t\t\t\t</span>'),a},head:function(){a.html+="<thead><tr>",a.html+=l._checkbox(),_.each(l.param.column,function(t,e){a.html+="<td>"+t.name+n.order(t.order,t.field)+"</td>",!0===t.search&&a.search.push(e)}),a.html+="</tr></thead>"},search:function(){var i='<div class="table-search"><form><div class="block-box">',o=[];_.each(a.search,function(t,e){i+='<div class="col-lg-3 col-md-3"><div class="form-group">';var a=l.param.column[t];if(null==l.param.search[a.field])i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t<span class="prepend">'+a.name+'</span>\n\t\t\t\t\t\t\t\t\t<input name="'+a.field+'" type="text" \n\t\t\t\t\t\t\t\t\t\tplaceholder="请输入'+a.name+'">\n\t\t\t\t\t\t\t\t</div>';else{var n=l.param.search[a.field];switch(n.type){case"select":i+='<select name="'+a.field+'" data-width="100%">\n\t\t\t\t\t\t\t\t\t\t\t<option value="'+module.conf.select_default_val+'">\n\t\t\t\t\t\t\t\t\t\t\t\t请选择'+a.name+"\n\t\t\t\t\t\t\t\t\t\t\t</option>",_.each(n.option,function(t){i+='<option value="'+t.val+'">\n\t\t\t\t\t\t\t\t\t\t\t\t'+t.key+"\n\t\t\t\t\t\t\t\t\t\t\t</option>"}),i+="</select>";break;case"datepicker":i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+a.name+'</span>\n\t\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\t\tid="table-datepicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\t\tclass="table-datepicker"\n\t\t\t\t\t\t\t\t\t\t\t\tname="'+a.field+'" \n\t\t\t\t\t\t\t\t\t\t\t\tdata-key="'+e+'"\n\t\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+a.name+'">\n\t\t\t\t\t\t\t\t\t\t</div>',o[e]=n.param;break;case"citypicker":i+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+a.name+'</span>\n\t\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\t\tid="table-citypicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\t\tclass="table-citypicker"\n\t\t\t\t\t\t\t\t\t\t\t\tname="'+a.field+'" \n\t\t\t\t\t\t\t\t\t\t\t\tdata-key="'+e+'"\n\t\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+a.name+'">\n\t\t\t\t\t\t\t\t\t\t</div>',o[e]=n.param}}i+="</div></div>"}),i+='<div class="col-lg-3 col-md-3">\n\t\t\t\t\t\t\t<button class="search-do highlight mr10">\n\t\t\t\t\t\t\t\t<i class="fa fa-search"></i>\n\t\t\t\t\t\t\t\t搜索\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button class="search-refresh" data-for="'+l.dom+'">\n\t\t\t\t\t\t\t\t<i class="fa fa-refresh"></i>\n\t\t\t\t\t\t\t\t重置\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div></form></div>',l.domCache.before(i),l.searchBox=l.domCache.prev(".table-search"),l.searchBox.find(".table-datepicker").each(function(){var t=$(this);Eadmin.datepicker("#"+t.attr("id"),o[t.data("key")])}),l.searchBox.find(".table-citypicker").each(function(){var t=$(this);Eadmin.citypicker("#"+t.attr("id"),o[t.data("key")])})},tools:function(){0!=l.param.config.button.length&&(a.tools='<div class="table-tools">',_.each(l.param.config.button,function(t,e){a.tools+=0==e?'<button class="highlight">':"<button>",null!=t.icon&&(a.tools+='<i class="fa '+t.icon+'"></i>'),a.tools+=t.name+"</button>"}),a.tools+="</div>",l.domCache.before(a.tools),l.toolsBox=l.domCache.prev(".table-tools"))},page:function(){if(!_.isBoolean(l.param.config.page)){var t='<div class="table-page">\n\t\t\t\t\t\t\t\t<span class="info">\n\t\t\t\t\t\t\t\t\t共<em></em>条，每页\n\t\t\t\t\t\t\t\t\t<select name="pagesize" data-width="60">\n\t\t\t\t\t\t\t\t\t\t<option value="10"'+(10==l.size?" selected":"")+'>10</option>\n\t\t\t\t\t\t\t\t\t\t<option value="30"'+(30==l.size?" selected":"")+'>30</option>\n\t\t\t\t\t\t\t\t\t\t<option value="50"'+(50==l.size?" selected":"")+'>50</option>\n\t\t\t\t\t\t\t\t\t\t<option value="100"'+(100==l.size?" selected":"")+">100</option>\n\t\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t\t条，\n\t\t\t\t\t\t\t\t\t当前 <em>"+l.page+'</em>/<em>-</em> 页\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span class="prev-page"><i class="fa fa-angle-left"></i></span>\n\t\t\t\t\t\t\t\t<span class="next-page"><i class="fa fa-angle-right"></i></span>\n\t\t\t\t\t\t\t\t<span class="jump">\n\t\t\t\t\t\t\t\t\t跳转到第\n\t\t\t\t\t\t\t\t\t<input name="page" type="text" placeholder="页数">\n\t\t\t\t\t\t\t\t\t页\n\t\t\t\t\t\t\t\t\t<button class="highlight small">确定</button>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>';l.domCache.after(t),l.pageBox=l.domCache.next(".table-page")}},fixed:function(){if(a.fixed="",l.param.config.fixed.first){a.fixed+='<div class="fixed-left">\n\t\t\t\t\t\t\t\t\t<table>\n\t\t\t\t\t\t\t\t\t\t<thead><tr>',a.fixed+=l._checkbox(null,!0);var t=_.head(l.param.column);a.fixed+="<td>"+t.name+n.order(t.order,t.field)+"</td>\n\t\t\t\t\t\t\t\t</tr></thead>",a.fixed+="<tbody></tbody>\n\t\t\t\t\t\t\t\t</table></div>"}if(l.param.config.fixed.last){a.fixed+='<div class="fixed-right">\n\t\t\t\t\t\t\t\t\t<table>\n\t\t\t\t\t\t\t\t\t\t<thead><tr>';var e=_.last(l.param.column);a.fixed+="<td>"+e.name+n.order(e.order,e.field)+"</td>\n\t\t\t\t\t\t\t\t</tr></thead>",a.fixed+="<tbody></tbody>\n\t\t\t\t\t\t\t\t</table></div>"}l.domCache.append(a.fixed)},body:function(){n.head(),n.search(),n.tools(),n.page(),a.html+="<tbody></tbody></table></div>",l.domCache.html(a.html),n.fixed(),0==l.param.config.button.length&&l.domCache.find("thead > tr").addClass("head-border-top"),l.table={head:l.domCache.find("thead"),body:l.domCache.find("tbody"),l:l.domCache.find(".fixed-left").find("tbody"),r:l.domCache.find(".fixed-right").find("tbody"),box:l.domCache.find(".table-box")},l.table.t=l.table.box.children("table"),l.table.c=l.table.t.children("tbody")}};this.shade.css("display","flex"),a.html='<div class="table-box" style="width:'+this.width+'px;">\n\t\t\t\t  \t<table>',n.body(),this._loadData()}},{key:"_event",value:function(){var t=[this.dom+" thead .checkall",this.dom+" tbody .checkall",this.dom+" tbody tr",".search-do",".search-refresh",".table-page select",".table-page .num-page:not(.current)",".table-page .prev-page",".table-page .next-page",".table-page button",".table-tools button",this.dom+" .order i:not(.active)",this.dom+" .checkbox-switch"],i=this,e=function(t){Eadmin.message.error({content:t}),i.pageBox.find("input").val("")},o=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(null!=t[module.conf.http.code_field]){var a="";if(null!=t[module.conf.http.msg_field]&&(a=t[module.conf.http.msg_field]),t[module.conf.http.code_field]==module.conf.http.code_success){var n={content:a=""==a?"操作执行成功":a};return null!=e&&(n.callback=e),void Eadmin.popup.success(n)}""==a&&(a="操作执行失败"),Eadmin.popup.error({content:a})}else console.log("接口返回结果中没有找到定义的code码字段")};if(i.param.config.checkbox&&box.on("click",t[0],function(){var t={this:$(this)};t.isCheck=t.this.is(":checked")?1:0,i.checked=1==t.isCheck?i.size:0,i.param.config.fixed.first?t.checkbox=i.table.l.find(".checkall"):t.checkbox=i.table.t.find(".checkall"),Form.checkbox(t.checkbox,t.isCheck)}).on("click",t[1],function(){var t={this:$(this)};i.checked+=t.this.is(":checked")?1:-1,t.checkall=i.table.head.find(".checkall"),t.isCheck=i.checked==i.size?1:0,Form.checkbox(t.checkall,t.isCheck)}),i.param.config.fixed.first||i.param.config.fixed.last){var a=0;box.on("mouseenter",t[2],function(){a=$(this).index(),i.table.c.children("tr").eq(a).addClass("tr-hover"),i.table.l.children("tr").eq(a).addClass("tr-hover"),i.table.r.children("tr").eq(a).addClass("tr-hover")}).on("mouseleave",t[2],function(){i.table.c.children("tr").eq(a).removeClass("tr-hover"),i.table.l.children("tr").eq(a).removeClass("tr-hover"),i.table.r.children("tr").eq(a).removeClass("tr-hover")})}null!=i.searchBox&&box.on("click",t[3],function(){i.page=1,i.get[i.param.config.page.page_field]=i.page;var t=i.searchBox.children("form").serialize(),e=_.split(t,"&");return _.each(e,function(t){var e=_.split(t,"=");i.get[e[0]]=e[1]}),i._loadData(!0),!1}).on("click",t[4],function(){return i.searchBox.find("input").val(""),Form.select(i.searchBox),!1}),null!=i.toolsBox&&_.each(i.param.config.button,function(n,t){if(null!=n.open){var e="table-btn-open-window-"+t;return i.toolsBox.find("button").eq(t).attr("id",e).data("window-url",n.open.url),Eadmin.window("#"+e,n.open),!0}i.toolsBox.find("button").eq(t).on("click",function(){if(!0!==n.check_checked||0!=i.checked){var t=function(){var t=[],e={},a=void 0;0<(a=i.param.config.fixed.first?i.table.l.find(".checkall:checked"):i.table.c.find(".checkall:checked")).length&&(a.each(function(){t.push($(this).val())}),t=_.toString(t),e[i.param.config.checkbox]=t),null==n.api?_.isFunction(n.callback)?n.callback(_.isArray(t)?"":t):console.log("按钮操作没有指明具体操作动作，无法执行"):axios.get(n.api,{params:e}).then(function(t){var e=t.data;o(e,function(){!0===n.refresh&&i._loadData()})})};!0!==n.confirm?t():Eadmin.popup.confirm({content:"确认执行此操作吗？",callback:t})}else Eadmin.popup.error({content:"请至少选择一项执行此操作"})})}),_.isBoolean(this.param.config.page)||box.on("change",t[5],function(){i.page=1,i.size=parseInt($(this).val()),i.get[i.param.config.page.size_field]=i.size,i._loadData(!0)}).on("click",t[6],function(){$(this);i.page=parseInt($(this).html()),i.get[i.param.config.page.page_field]=i.page,i._loadData(!0)}).on("click",t[7],function(){1!=i.page&&(i.page-=1,i.get[i.param.config.page.page_field]=i.page,i._loadData(!0))}).on("click",t[8],function(){i.page!=i.pageCount&&(i.page+=1,i.get[i.param.config.page.page_field]=i.page,i._loadData(!0))}).on("click",t[9],function(){var t=i.pageBox.find("input").val();""!=t?t<1?e("跳转的页数不能小于1"):t>i.pageCount?e("跳转的页数已经超出了最大页数"):t!=i.page?(i.page=parseInt(t),i.get[i.param.config.page.page_field]=i.page,i._loadData(!0)):e("已经在待跳转的页面了"):e("跳转的页数不能为空")}),box.on("click",t[11],function(){var t={this:$(this)};i.table.head.find(".active").removeClass("active"),t.this.addClass("active"),i.get.order=t.this.data("order"),i._loadData()}).on("click",t[12],function(){var t={this:$(this)};t.label=t.this.prev("label"),t.api=t.label.data("api"),t.field=t.label.data("field"),t.val=1==t.label.children().val()?0:1,t.param={},t.param[t.field]=t.val,axios.get(t.api,{params:t.param}).then(function(t){var e=t.data;o(e)}).catch(function(t){console.log(t)})});var n=_.findIndex(this.param.column,function(t){return null!=t.button});-1!=n&&_.each(this.param.column[n].button,function(a,t){if(null!=a.open)return Eadmin.window(".column-btn-"+t,a.open),!0;null!=a.api&&box.on("click",".column-btn-"+t,function(){var t=$(this).data("api"),e=function(){axios.get(t).then(function(t){var e=t.data;o(e,function(){!0===a.refresh&&i._loadData()})})};!0!==a.confirm?e():Eadmin.popup.confirm({content:"确定执行此操作吗？",callback:e})})})}},{key:"_checkbox",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return!1===this.param.config.checkbox?"":this.param.config.fixed.first&&!e?'<td class="td-checkbox"><div></div></td>':null==t?'<td class="td-checkbox"><div>\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<input type="checkbox" class="checkall">\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div></td>':null==t[this.param.config.checkbox]?(console.log("复选框绑定的字段"+this.param.config.checkbox+"不存在"),""):'<td class="td-checkbox"></div>\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<input type="checkbox" class="checkall" value="'+t[this.param.config.checkbox]+'">\n\t\t\t\t\t</label>\n\t\t\t\t</div></td>'}},{key:"_page",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(!_.isBoolean(this.param.config.page))if(_.has(t,"count")){box[0].scrollTop=0,this.init||this.pageBox.data("size",this.size);var a={count:this.pageBox.find("em:first"),page:this.pageBox.find("em").eq(1),pageCount:this.pageBox.find("em").eq(2)};t.count==parseInt(a.count.html())&&this.size==this.pageBox.data("size")||(t.count<this.size?this.pageCount=1:t.count%this.size==0?this.pageCount=t.count/this.size:this.pageCount=parseInt(t.count/this.size)+1,a.count.html(t.count),a.pageCount.html(this.pageCount),this.size!=this.pageBox.data("size")&&this.pageBox.data("size",this.size)),a.page.html(this.page);var n=10;_.has(this.param.config.page,"num")&&((n=this.param.config.page.num)<3&&(n=3),10<n&&(n=10));var i="",o=this.page,l=n+((o-=_.floor(n/2))<1?(o=1,0):this.page-_.floor(n/2)-1);l>this.pageCount&&(l=this.pageCount),l-o<n-1&&(o-=n-(l-o)-1),o<1&&(o=1);for(var c=o;c<=l;c++)i+='<span class="num-page'+(c==this.page?" current":"")+'" data-page="'+c+'">'+c+"</span>";this.pageBox.find(".num-page").remove(),this.pageBox.find(".prev-page").after(i),this.init&&e&&Eadmin.message.success({content:"当前第 "+this.page+" 页，共 "+this.pageCount+" 页"})}else console.log("数据源中未包含数据总条数count字段，创建分页失败")}},{key:"_loadData",value:function(){var c=this,a=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.checked=0,this.shade.css("display","flex"),axios.get(this.param.config.data,{params:this.get}).then(function(t){var n={data:t.data,html:"",fl:"",fr:""};if(null!=n.data.count||!1===c.param.config.page)if(null!=n.data.list){_.each(n.data.list,function(l){n.fl+="<tr>",n.html+="<tr>",n.fr+="<tr>",n.html+=c._checkbox(l),n.fl+=c._checkbox(l,!0),_.each(c.param.column,function(t,e){var o="<td>";if(!0===t.switch){var a=t.api;null==a&&console.log("没有指定保存开关状态的API地址"),a=_.replace(a,/\$(\w+)/g,function(t){return t=_.replace(t,"$",""),l[t]}),o+='<label class="no-padding" data-api="'+a+'" data-field="'+t.field+'">\n\t\t\t\t\t\t\t\t\t<input type="checkbox" data-model="switch"'+(1==l[t.field]?" checked":"")+">\n\t\t\t\t\t\t\t\t</label>"}else _.isArray(t.button)?_.each(t.button,function(t,e){var a="";null!=t.icon&&(a='<i class="fa '+t.icon+'"></i>');var n="";null!=t.api&&(n=_.replace(t.api,/\$(\w+)/g,function(t){return t=_.replace(t,"$",""),l[t]}));var i="";null!=t.open&&(i=_.replace(t.open.url,/\$(\w+)/g,function(t){return t=_.replace(t,"$",""),l[t]})),o+='<button \n\t\t\t\t\t\t\t\t\t\tdata-api="'+n+'" \n\t\t\t\t\t\t\t\t\t\tdata-window-url="'+i+'"\n\t\t\t\t\t\t\t\t\t\tclass="small mr5 column-btn-'+e+'" \n\t\t\t\t\t\t\t\t\t\tstyle="background:'+c.color[e]+';"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t'+a+" "+t.name+"\n\t\t\t\t\t\t\t\t\t</button>"}):o+=l[t.field];o+="</td>",0==e&&(n.fl+=o),n.html+=o,e+1==c.param.column.length&&(n.fr+=o)}),n.fl+="</tr>",n.html+="</tr>",n.fr+="</tr>"}),c.table.c.html(n.html),Eadmin.form(c.table.c),!0===c.param.config.fixed.first&&(c.table.l.html(n.fl),Eadmin.form(c.table.l)),!0===c.param.config.fixed.last&&(c.table.r.html(n.fr),Eadmin.form(c.table.r)),c._page(n.data,a);var e=c.table.head.find(":checkbox");e.is(":checked")&&Form.checkbox(e,!1),c.shade.hide(),c.init||(c.table.t.width()<=c.width?c.table.t.width(c.width):(c.domCache.children(".table-box").css("padding-bottom","18px"),Eadmin.scroll(c.dom+" .table-box","x")),c.init=!0)}else console.log("数据源中没有包含list字段，创建表格失败");else console.log("返回的数据源中没有 count 字段，无法使用分页，请在配置中设置 page 为 false")}).catch(function(t){console.log(t)})}}]),a}();